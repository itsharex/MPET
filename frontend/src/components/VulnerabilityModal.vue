<template>
  <a-modal
    v-model:open="visible"
    title="漏洞信息管理"
    width="1200px"
    :footer="null"
    @cancel="handleClose"
  >
    <div style="margin-bottom: 16px">
      <a-button type="primary" @click="showAddModal">
        <PlusOutlined /> 添加漏洞信息
      </a-button>
    </div>

    <a-table
      :columns="columns"
      :data-source="vulnerabilities"
      :loading="loading"
      :pagination="{ pageSize: 10 }"
      row-key="id"
      size="small"
    >
      <template #bodyCell="{ column, record }">
        <template v-if="column.key === 'service_type'">
          {{ record.service_type.replace(/_Weak$|_Unauth$/, '') }}
        </template>
        <template v-if="column.key === 'vuln_type'">
          <a-tag :color="record.service_type.endsWith('_Weak') ? 'orange' : 'blue'">
            {{ record.service_type.endsWith('_Weak') ? '弱口令' : '未授权访问' }}
          </a-tag>
        </template>
        <template v-if="column.key === 'level'">
          <a-tag :color="getLevelColor(record.level)">
            {{ record.level }}
          </a-tag>
        </template>
        <template v-if="column.key === 'description'">
          <div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap">
            {{ record.description }}
          </div>
        </template>
        <template v-if="column.key === 'action'">
          <a-space :size="4">
            <a-button type="link" size="small" @click="showEditModal(record)">
              <EditOutlined /> 编辑
            </a-button>
            <a-popconfirm title="确定删除?" @confirm="handleDelete(record.id)">
              <a-button type="link" danger size="small">
                <DeleteOutlined /> 删除
              </a-button>
            </a-popconfirm>
          </a-space>
        </template>
      </template>
    </a-table>

    <!-- 添加/编辑漏洞信息对话框 -->
    <a-modal
      v-model:open="formVisible"
      :title="editingVuln ? '编辑漏洞信息' : '添加漏洞信息'"
      @ok="handleSave"
      @cancel="resetForm"
      width="800px"
    >
      <a-form :model="form" layout="vertical">
        <a-form-item label="服务类型" required>
          <a-select v-model:value="form.service_type" placeholder="选择服务类型" show-search>
            <a-select-option v-for="type in serviceTypes" :key="type.value" :value="type.value">
              {{ type.label }}
            </a-select-option>
          </a-select>
        </a-form-item>
        <a-form-item label="漏洞类型" required>
          <a-select v-model:value="form.vuln_type" placeholder="选择漏洞类型">
            <a-select-option value="Weak">弱口令</a-select-option>
            <a-select-option value="Unauth">未授权访问</a-select-option>
          </a-select>
        </a-form-item>
        <a-form-item label="漏洞名称" required>
          <a-input v-model:value="form.name" placeholder="例如：Redis 未授权访问漏洞" />
        </a-form-item>
        <a-form-item label="风险等级" required>
          <a-select v-model:value="form.level" placeholder="选择风险等级">
            <a-select-option value="高危">高危</a-select-option>
            <a-select-option value="中危">中危</a-select-option>
            <a-select-option value="低危">低危</a-select-option>
          </a-select>
        </a-form-item>
        <a-form-item label="漏洞描述" required>
          <a-textarea
            v-model:value="form.description"
            placeholder="详细描述漏洞的原理、影响和危害"
            :rows="6"
          />
        </a-form-item>
        <a-form-item label="修复建议" required>
          <a-textarea
            v-model:value="form.repair"
            placeholder="提供详细的修复建议，每行一条建议"
            :rows="8"
          />
        </a-form-item>
      </a-form>
    </a-modal>
  </a-modal>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { message } from 'ant-design-vue'
import {
  PlusOutlined,
  EditOutlined,
  DeleteOutlined,
} from '@ant-design/icons-vue'
import { GetAllVulnerabilities, SaveVulnerability, DeleteVulnerability, GetServiceTypes } from '../../wailsjs/go/backend/App'
import type { models } from '../../wailsjs/go/models'

const props = defineProps<{
  open: boolean
}>()

const emit = defineEmits<{
  (e: 'close'): void
}>()

const visible = ref(props.open)
const loading = ref(false)
const vulnerabilities = ref<models.VulnerabilityInfo[]>([])
const serviceTypes = ref<any[]>([])

const formVisible = ref(false)
const editingVuln = ref<models.VulnerabilityInfo | null>(null)
const form = ref({
  id: '',
  service_type: '',
  vuln_type: 'Weak', // 新增：漏洞类型（Weak 或 Unauth）
  name: '',
  level: '',
  description: '',
  repair: '',
})

const columns = [
  { title: '服务类型', key: 'service_type', width: 120 },
  { title: '漏洞类型', key: 'vuln_type', width: 100 },
  { title: '漏洞名称', dataIndex: 'name', key: 'name', width: 200 },
  { title: '风险等级', key: 'level', width: 80 },
  { title: '漏洞描述', key: 'description', width: 300 },
  { title: '操作', key: 'action', width: 150, fixed: 'right' },
]

onMounted(async () => {
  await loadServiceTypes()
  await loadVulnerabilities()
})

async function loadServiceTypes() {
  try {
    serviceTypes.value = await GetServiceTypes()
  } catch (error) {
    console.error('加载服务类型失败:', error)
  }
}

async function loadVulnerabilities() {
  loading.value = true
  try {
    vulnerabilities.value = await GetAllVulnerabilities()
  } catch (error) {
    message.error(`加载漏洞信息失败: ${error}`)
  } finally {
    loading.value = false
  }
}

function getLevelColor(level: string): string {
  const colors: Record<string, string> = {
    '高危': 'red',
    '中危': 'orange',
    '低危': 'green',
  }
  return colors[level] || 'default'
}

function showAddModal() {
  editingVuln.value = null
  resetForm()
  formVisible.value = true
}

function showEditModal(record: models.VulnerabilityInfo) {
  editingVuln.value = record
  
  // 解析服务类型和漏洞类型
  let serviceType = record.service_type
  let vulnType = 'Weak'
  
  if (serviceType.endsWith('_Weak')) {
    serviceType = serviceType.replace('_Weak', '')
    vulnType = 'Weak'
  } else if (serviceType.endsWith('_Unauth')) {
    serviceType = serviceType.replace('_Unauth', '')
    vulnType = 'Unauth'
  }
  
  form.value = {
    id: record.id,
    service_type: serviceType,
    vuln_type: vulnType,
    name: record.name,
    level: record.level,
    description: record.description,
    repair: record.repair,
  }
  formVisible.value = true
}

function resetForm() {
  form.value = {
    id: '',
    service_type: '',
    vuln_type: 'Weak',
    name: '',
    level: '',
    description: '',
    repair: '',
  }
}

async function handleSave() {
  if (!form.value.service_type || !form.value.vuln_type || !form.value.name || !form.value.level || !form.value.description || !form.value.repair) {
    message.warning('请填写所有必填项')
    return
  }

  try {
    // 组合服务类型和漏洞类型
    const fullServiceType = `${form.value.service_type}_${form.value.vuln_type}`
    
    const vulnData = {
      id: form.value.id,
      service_type: fullServiceType,
      name: form.value.name,
      level: form.value.level,
      description: form.value.description,
      repair: form.value.repair,
    }
    
    await SaveVulnerability(vulnData as any)
    message.success(editingVuln.value ? '更新成功' : '添加成功')
    formVisible.value = false
    resetForm()
    await loadVulnerabilities()
  } catch (error) {
    message.error(`保存失败: ${error}`)
  }
}

async function handleDelete(id: string) {
  try {
    await DeleteVulnerability(id)
    message.success('删除成功')
    await loadVulnerabilities()
  } catch (error) {
    message.error(`删除失败: ${error}`)
  }
}

function handleClose() {
  emit('close')
}

// 监听 props 变化
import { watch } from 'vue'
watch(() => props.open, (newVal) => {
  visible.value = newVal
  if (newVal) {
    loadVulnerabilities()
  }
})

watch(visible, (newVal) => {
  if (!newVal) {
    emit('close')
  }
})
</script>

<style scoped>
:deep(.ant-table-cell) {
  padding: 8px 8px !important;
}

:deep(.ant-btn-sm) {
  padding: 0 4px;
  font-size: 13px;
  height: 24px;
  line-height: 22px;
}

:deep(.ant-btn-link) {
  padding: 0 6px;
}
</style>
